# Changelog

## 2026-02-21 - Рефакторинг дублирования (этапы 1-8)

### Централизация фильтров и пользовательских дефолтов

- Вынесены единые справочники и нормализация download-фильтров (`source/sort/period/base`, профили) в `core/download_filters.py`.
- Объединена логика чтения и нормализации пользовательских дефолтов в `core/user_preferences.py`.
- Runtime и handlers переведены на единый слой дефолтов, чтобы убрать расхождения между `/download`, настройками и prompt editor.

### Prompt editor: удаление дублирующихся handler-flow

- Параметризованы повторяющиеся edit/thematic ветки выбора значений и custom input.
- Вынесены общие контролы улучшений (`Hi-res/PAG`) в `core/prompt_enhancements.py` и подключены как в главном редакторе, так и в меню улучшения готовой картинки.
- Добавлены общие helper-модули `prompt_editor_selection_utils.py` и `prompt_editor_enhancements.py` для единообразного парсинга callback-выборов и отображения счётчика улучшений.

### Декомпозиция крупных handler-модулей

- Из крупных файлов вынесены utility-слои:
  - `handlers/common_core_utils.py`,
  - `handlers/download_flow_utils.py`,
  - `handlers/prompt_editor_send_menu_utils.py`.
- Сохранено прежнее поведение пользовательских сценариев при уменьшении копипаста и связности.

### Исправления регрессий в процессе рефакторинга

- Исправлен callback-timeout в `Продолжить поиск` (раннее подтверждение callback + безопасное уведомление через UI).
- Восстановлено прежнее поведение запуска улучшения готовой картинки: все улучшения снова полностью опциональны.

### Тесты

- Добавлены тесты для новых utility-слоёв (`user_preferences`, `prompt_enhancements`, `download_flow_utils`, `prompt_editor_send_menu_utils`, selection/enhancements helpers prompt editor).
- Актуальный baseline после изменений: `python -m pytest` проходит.

## 2026-02-20 - Меню улучшения и потоковая выдача батча

### Улучшение сгенерированных изображений

- Переработано меню улучшения превью: настройки сгруппированы по тематическим разделам, как в редакторе (`Сэмплинг`, `Улучшения`, `Размер`).
- Добавлена опция `Сжатие (%)` для итогового результата:
  - процент уменьшает ширину и высоту с сохранением пропорций,
  - применяется в конце цепочки (после sampler/hi-res/upscaler).
- Добавлен инструмент `Shrink XxY` (лимит по рамке):
  - уменьшает изображение до указанной рамки без апскейла,
  - поддерживает пресеты, ручной ввод (`XxY`) и отключение.
- Расширено хранение preview-артефактов в runtime: сохраняются параметры `compression_percent` и `shrink_width/shrink_height`.

### Генерация батча

- Изменён UX отправки батча: картинки отправляются по мере готовности, а не только после завершения всего батча.
- Каждая отправленная картинка сразу регистрируется как отдельная превью с действиями `PNG`/`Улучшить`.
- Добавлена дедупликация realtime/history-результатов по ключам output-изображений, чтобы избежать повторной отправки.
- В статус генерации добавлен индикатор получения превью: `Получено: X/N`.

## 2026-02-20 - Большая сессия рефакторинга и стабилизации

### Core и архитектура

- Вынесены доменные сущности и утилиты в `core/*`:
  - `core/models.py` (`GenerationParams`),
  - `core/formatting.py` (`human_size`, `short_number`),
  - `core/queue_utils.py`,
  - `core/ui_copy.py`.
- Добавлено хранение и восстановление runtime-состояния для расширенных сценариев:
  - активные генерации,
  - preview-артефакты,
  - пользовательские UI-панели,
  - пользовательские настройки интерфейса и дефолтов.
- Усилен runtime-харденинг: убраны broad `except Exception` на критических путях, заменены на конкретные исключения.
- Убраны runtime-`assert` проверки из пользовательских сценариев.

### Рефакторинг handlers

- Проведена декомпозиция крупных модулей:
  - `handlers/common.py` -> `common_core_handlers.py`, `common_ops_handlers.py` + orchestration,
  - `handlers/download.py` + `download_flow_handlers.py`,
  - `handlers/prompt_editor.py` + набор специализированных `prompt_editor_*` модулей.
- Снижена связность, улучшена тестируемость и читаемость, внедрены dependency dataclass-контракты между модулями.

### Качество и CI

- Добавлены и настроены:
  - `pyproject.toml` (ruff, mypy, pytest),
  - `.pre-commit-config.yaml`,
  - `requirements-dev.txt`,
  - `.github/workflows/ci.yml`.
- Mypy-покрытие включает handlers-слой, временные `ignore_errors` сняты.
- Текущий baseline: `ruff`, `mypy`, `pytest`, `compileall` проходят.

### UI/UX и стабильность (Telegram)

- Добавлена единая навигация (назад/в меню) в критичных ветках:
  - обновление списка моделей,
  - скачивание модели,
  - удаление локальной модели,
  - очередь,
  - обучение,
  - настройки,
  - сценарии отмены.
- Исправлен баг “`message is not modified` -> создаётся новое сообщение” в panel-rendering.
- Исправлены регрессии сигнатур после рефакторинга (`show_prompt_editor`, `open_paginated_choice` и т.д.).

### Обучение и настройки

- Обучение переведено на многостраничный режим с переключением `Простой/Расширенный` прямо в UI.
- `Сервис -> Настройки` сделано интерактивным:
  - группировка по темам,
  - переключение UI-режима,
  - актуальный статус сервиса.
- Добавлены редактируемые дефолты генерации:
  - size, steps, cfg, denoise, seed, batch, sampler, scheduler,
  - отдельные подменю выбора,
  - ручной ввод,
  - сброс к дефолтам.
- Ручной ввод значений “съедается” (пользовательские сообщения удаляются при возможности), FSM-ветки стабилизированы.

### Пресеты и задачи

- Улучшен UX пресетов в `Генерация`:
  - корректный edit-поток без “зависающих” лишних сообщений,
  - навигация назад/в меню,
  - корректный `uid` в callback-пути.
- Исправлен сценарий `Мои задачи`, где иногда показывалось “нет активных задач” при фактической активности.

### Скачивание и поиск моделей

- Расширены фильтры поиска:
  - source/sort/period/base/nsfw,
  - отдельное подменю base models,
  - расширенный набор base-моделей (`SD 1.5`, `SD 2.x`, `SDXL 0.9/1.0`, `SD 3/3.5`, `Pony`, `Flux`, `Illustrious`, `NoobAI`).
- Добавлен фильтр по авторам CivitAI:
  - в поиске,
  - в настройках по умолчанию,
  - поддержка списка авторов через запятую.
- Добавлены быстрые профили фильтров (`Популярные`, `Новые`, `Рейтинг`, `Anime`).
- Добавлена постраничная выдача результатов и подгрузка:
  - `N` результатов на страницу (5/8/10),
  - `Продолжить поиск`,
  - `В начало/Назад/Далее/В конец`.
- Добавлен возврат из экрана подтверждения выбранной модели обратно к результатам.

### Критический фикс CivitAI поиска

- Исправлена ключевая ошибка: поиск учитывал только первую страницу CivitAI-ответа.
- Реализован cursor-based обход страниц (`nextCursor`) и сбор результатов по нескольким страницам.
- Усилен локальный текстовый матчинг результатов (name/description/tags/trained words/metadata),
  а также устойчивый матчинг автора и base model.
- Введены fallback-проходы для случаев, когда API возвращает пустой `items` на первой странице.

### Prompt editor / generation

- Улучшен поток улучшения изображения:
  - добавлена кнопка отмены,
  - корректный статус при `CancelledError`.
- Уточнены typing-контракты и callback safety для aiogram-union путей.

### Документация

- Обновлены `README.md`, `CONTRIBUTING.md`, `docs/CONFIG.md`, `docs/COMMANDS.md`, `docs/TRAINING.md`.
- Команды и инструкции синхронизированы с текущим поведением UI и quality-процессом.
