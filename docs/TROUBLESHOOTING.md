# Troubleshooting

## Бот не стартует: `TELEGRAM_BOT_TOKEN is not set`

Причина: в `.env` не задан токен.

Что сделать:

1. Проверьте, что файл `.env` существует.
2. Заполните `TELEGRAM_BOT_TOKEN`.
3. Перезапустите бота.

## Ошибка подключения к ComfyUI

Симптомы:

- `/models` возвращает ошибку подключения
- генерация падает сразу

Проверьте:

1. ComfyUI запущен.
2. `COMFYUI_URL` в `.env` правильный.
3. Сеть/порт доступны для процесса бота.

## В ComfyUI нет доступных checkpoints

Симптом: бот пишет, что на сервере нет checkpoint.

Что сделать:

1. Скопируйте checkpoint в `<COMFYUI_MODELS_PATH>/checkpoints`.
2. Обновите список через `/models`.
3. Убедитесь, что ComfyUI действительно видит файл.

## Smart Prompt не работает

Частые причины:

- `SMART_PROMPT_PROVIDER=disabled`
- не установлены зависимости `tipo-kgen`, `transformers`, `torch`
- не удалось загрузить TIPO модель (неверный `SMART_PROMPT_MODEL` или нет ресурсов)
- слишком длинный входной текст

Что сделать:

1. Проверьте настройки в `.env`.
2. Проверьте логи и текст ошибки в Telegram.
3. Установите/обновите зависимости и перезапустите бота.
4. Если используете CPU, попробуйте уменьшить длину промпта или увеличить `SMART_PROMPT_TIMEOUT`.

## `/download` не находит модель

Проверьте:

1. Корректность текста запроса.
2. Выбранный источник (CivitAI/HuggingFace).
3. Фильтры (base model, период, NSFW).
4. Токены API для приватных/gated моделей.

Если есть прямая ссылка на модель, вставьте её вместо текста запроса.

## Скачивание оборвалось

Возможные причины:

- сеть/таймаут
- удалённый сервер ограничил доступ
- файл уже существует в целевой папке

Что сделать:

1. Повторить скачивание.
2. Проверить, нет ли файла с тем же именем.
3. Проверить токены `CIVITAI_API_KEY` / `HUGGINGFACE_TOKEN`.

## Бот не отвечает в Telegram

Проверьте whitelist:

- если `ALLOWED_USERS` не пустой, ваш Telegram ID должен быть в списке;
- ID указываются через запятую, без пробелов или с аккуратным trim.

## Фото не отправляются как превью

Иногда Telegram отклоняет большие/нестандартные изображения как photo.

Бот автоматически пробует fallback: отправка как PNG-документ.

Если нужно только PNG, используйте кнопку `PNG без сжатия` после генерации.

## Где смотреть логи

Логи пишутся в stdout/stderr.

Минимальный полезный набор при диагностике:

- сообщение об ошибке из Telegram
- последние строки лога бота
- значения ключевых переменных (`COMFYUI_URL`, `SMART_PROMPT_PROVIDER`, `SMART_PROMPT_MODEL`, `ALLOWED_USERS`)
