# План миграции UI на расширяемую архитектуру

## Статус

- Текущий этап: **Этап 11 (финализация)**.
- Документ является обязательным контрактом для всех следующих этапов.
- Отклонения от контракта допустимы только через отдельное обновление этого файла.

### Выполненные этапы

- ✅ Этап 0: контракт и протокол миграции.
- ✅ Этап 1: foundation слоя `core/ui_kit`.
- ✅ Этап 2: interaction layer (`core/interaction.py`, унификация panel rendering).
- ✅ Этап 3: callback schema layer (`core/callbacks.py`) и базовая миграция пагинации.
- ✅ Этап 4: shell редактора переведен на shared UI builders.
- ✅ Этап 5: edit/flow/smart/exchange переведены на единые callback/interaction шаблоны.
- ✅ Этап 6: heavy-блоки (thematic/send/lora/references) модульно переработаны.
- ✅ Этап 7: common/service UI переведен на shared builders.
- ✅ Этап 8: download wizard переведен на shared components и schema callbacks.
- ✅ Этап 9: presets UI переведен на shared components и единые confirm/back паттерны.
- ✅ Этап 10: удалены legacy UI-пути и дубли helper-логики.

## Цель миграции

Перевести интерфейс бота на архитектуру, где добавление нового функционала делается через
переиспользуемые компоненты и декларативные схемы, без копирования одинаковых блоков
кнопок и callback-обработки.

Ключевые эффекты:

- одна точка правки для базовой навигации (назад, отмена, в меню);
- единый способ сборки клавиатур и диалогов;
- единая обработка callback/message для редактирования панелей;
- предсказуемое расширение через модульные UI-блоки.

## Целевая архитектура интерфейса

### 1) UI Core Layer

Назначение: декларативная сборка кнопок, рядов и клавиатур.

- Модули: `core/ui/*` (фабрики кнопок, навигация, диалоги, пагинация, шаблоны экранов).
- Ответственность:
  - типовые кнопки (`back`, `cancel`, `menu_root`, `confirm`);
  - типовые ряды и группы;
  - пагинация и навигационные панели;
  - стандартные диалоговые клавиатуры.

### 2) Interaction Layer

Назначение: единый жизненный цикл от callback к редактированию/отправке сообщения.

- Модули: `core/interaction.py`, `core/panels.py` (после миграции).
- Ответственность:
  - безопасное извлечение `Message` из callback;
  - единые сообщения об ошибках UI-канала;
  - `edit-or-answer` поведение;
  - якорное обновление пользовательской панели.

### 3) Callback Schema Layer

Назначение: типизированные callback-данные вместо ручного парсинга.

- Модули: `core/callbacks.py`.
- Ответственность:
  - описание callback-контрактов;
  - упаковка/распаковка данных;
  - снижение риска ошибок из-за `split(':')`.

### 4) Feature UI Modules

Назначение: экраны конкретных фич на базе общих компонентов.

- Модули: `handlers/*`.
- Ответственность:
  - только сценарная логика и связка состояний;
  - никаких ручных low-level паттернов, если они уже есть в UI Core/Interaction.

## Непререкаемые правила (Definition of Architecture)

1. Базовые навигационные кнопки не создаются вручную в feature-обработчиках.
2. Новые callback-контракты не парсятся через `split(':')`; используется схема callbacks layer.
3. Повторяющиеся шаблоны клавиатур не копируются между модулями; выносятся в shared builders.
4. Логика fallback-рендера панели не дублируется по handlers; используется interaction layer.
5. Любой новый UI-экран обязан быть собран из модульных строительных блоков.
6. Изменение UX-поведения во время миграции допускается только если явно описано в этапе.

## Протокол выполнения каждого этапа (обязательный)

Для каждого этапа применяется одинаковая последовательность:

1. Внести изменения только в рамках текущего этапа.
2. Уведомить пользователя о завершении внесения изменений.
3. Выполнить полную ручную проверку по матрице `R01-R13` (или релевантному поднабору, если
   этап инфраструктурный и не меняет runtime-поведение).
4. Зафиксировать результат коммитом с понятным описанием цели этапа.

## Матрица полной ручной проверки

- `R01`: `/start`, главное меню, переходы `Генерация/Модели/Сервис/Отмена`.
- `R02`: `/generate`, открытие редактора, `Назад`, `Отмена`, `В меню`.
- `R03`: редактирование `Positive/Negative`, возврат, сохранение состояния.
- `R04`: размер, steps, cfg, seed, batch, sampler/scheduler.
- `R05`: LoRA (добавить, удалить, очистить, подтверждения).
- `R06`: референсы (добавить, превью, удалить, очистить).
- `R07`: Smart Prompt (если включен).
- `R08`: запуск генерации, прогресс, отмена.
- `R09`: экран результатов (новая генерация, отмена, в меню).
- `R10`: пресеты (сохранить, перезапись, загрузить, удалить).
- `R11`: download-flow (тип, источник, фильтры, поиск, подтверждение, отмена).
- `R12`: `/models`, `/queue`, `/jobs`, `/settings`, `/cancel`.
- `R13`: рестарт и проверка восстановления runtime-состояния.

## Декомпозиция миграции на этапы

### Этап 0 - Контракт и правила

- Зафиксировать целевую архитектуру и протокол миграции.
- Артефакты: `docs/UI_MIGRATION_PLAN.md`, обновление `docs/ARCHITECTURE.md`.

### Этап 1 - UI Core Foundation

- Ввести общие UI-компоненты и builders без изменения пользовательского поведения.

### Этап 2 - Interaction Layer

- Унифицировать callback-message проверки и рендер панелей.

### Этап 3 - Callback Schemas

- Ввести типизированные callback-данные и убрать ручной парсинг в новых/мигрируемых экранах.

### Этап 4 - Prompt Editor Shell

- Перенести каркас редактора на shared UI-компоненты.

### Этап 5 - Prompt Editor (edit/flow/smart/exchange)

- Перевести сценарные экраны этих модулей на новую архитектуру.

### Этап 6 - Prompt Editor (thematic/send/lora/references)

- Модульно разрезать крупные UI-блоки и убрать дубли.

### Этап 7 - Common/Service UI

- Унифицировать меню и сервисные экраны.

### Этап 8 - Download UI

- Перевести мастер скачивания на shared шаблоны экранов.

### Этап 9 - Presets UI

- Перевести пресеты на shared диалоговые шаблоны и подтверждения.

### Этап 10 - Legacy Cleanup (бесповоротный)

- Удалить устаревшие UI-пути и временные совместимости.

### Этап 11 - Финализация

- Финальный регрессионный проход, обновление документации, фиксация целевой структуры.

## Критерии завершения полной миграции

- Feature-handlers не содержат дублирования базовых UI-паттернов.
- Новые callback-контракты описаны схемами и не зависят от ручного парсинга.
- Рендер панелей централизован и консистентен.
- Добавление нового экрана делается через переиспользуемые UI-компоненты.

## Базовый шаблон расширения после миграции

При добавлении новой UI-фичи использовать следующий порядок:

1. Описать callback-схему в `core/callbacks.py` (или переиспользовать существующую).
2. Собрать клавиатуры через `core/ui_kit/*` (без ручного дублирования кнопок навигации).
3. Использовать interaction-хелперы (`require_callback_message`, `edit_or_answer`, `show_prompt_panel`/`render_user_panel`).
4. Добавить локальные тесты на parser/formatter-логику, если добавлен новый callback/helper.
5. Прогнать `ruff` + `pytest` и ручной сценарий для затронутой ветки.
