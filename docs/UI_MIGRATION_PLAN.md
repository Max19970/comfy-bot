# UI архитектура и правила расширения

## Назначение

Этот документ фиксирует действующую архитектуру интерфейса бота и единые правила
добавления новых экранов без дублирования логики.

## Архитектура интерфейса

### 1) UI Core Layer

Назначение: декларативная сборка кнопок, рядов и клавиатур.

- Модули: `core/ui_kit/*`, `core/ui.py`.
- Ответственность:
  - типовые кнопки (`back`, `cancel`, `menu_root`, `confirm`);
  - типовые ряды и группы кнопок;
  - пагинация и навигационные панели;
  - стандартные диалоговые клавиатуры.

### 2) Interaction Layer

Назначение: единый жизненный цикл от callback к редактированию/отправке сообщения.

- Модули: `core/interaction.py`, `core/panels.py`.
- Ответственность:
  - безопасное извлечение `Message` из callback;
  - единые сообщения об ошибках UI-канала;
  - `edit-or-answer` поведение;
  - якорное обновление пользовательской панели.

### 3) Callback Schema Layer

Назначение: типизированные callback-данные вместо ручного парсинга.

- Модули: `core/callbacks.py`.
- Ответственность:
  - описание callback-контрактов;
  - упаковка/распаковка данных;
  - валидация и безопасная обработка payload.

### 4) Feature UI Modules

Назначение: экраны конкретных фич на базе общих компонентов.

- Модули: `handlers/*`.
- Ответственность:
  - сценарная логика и связка состояний;
  - композиция интерфейса из shared builders и interaction helper-ов.

## Обязательные правила

1. Базовые навигационные кнопки не создаются вручную в feature-обработчиках.
2. Callback-контракты обрабатываются через схемы в `core/callbacks.py`.
3. Повторяющиеся шаблоны клавиатур выносятся в shared builders.
4. Логика fallback-рендера панели используется из interaction layer.
5. Новый UI-экран собирается из модульных блоков, а не из локального копипаста.

## Паттерн добавления новой UI-фичи

1. Описать callback-схему в `core/callbacks.py` (или переиспользовать существующую).
2. Собрать клавиатуры через `core/ui_kit/*`.
3. Использовать interaction helper-ы (`require_callback_message`, `edit_or_answer`,
   `show_prompt_panel`/`render_user_panel`).
4. Добавить тесты на parser/formatter-логику при появлении нового callback/helper.
5. Прогнать `ruff`, `pytest` и ручной сценарий для затронутой ветки.

## Матрица ручной проверки

- `R01`: `/start`, главное меню, переходы `Генерация/Модели/Сервис/Отмена`.
- `R02`: `/generate`, открытие редактора, `Назад`, `Отмена`, `В меню`.
- `R03`: редактирование `Positive/Negative`, возврат, сохранение состояния.
- `R04`: размер, steps, cfg, seed, batch, sampler/scheduler.
- `R05`: LoRA (добавить, удалить, очистить, подтверждения).
- `R06`: референсы (добавить, превью, удалить, очистить).
- `R07`: Smart Prompt (если включен).
- `R08`: запуск генерации, прогресс, отмена.
- `R09`: экран результатов (новая генерация, отмена, в меню).
- `R10`: пресеты (сохранить, перезапись, загрузить, удалить).
- `R11`: download-flow (тип, источник, фильтры, поиск, подтверждение, отмена).
- `R12`: `/models`, `/queue`, `/jobs`, `/settings`, `/cancel`.
- `R13`: рестарт и проверка восстановления runtime-состояния.
